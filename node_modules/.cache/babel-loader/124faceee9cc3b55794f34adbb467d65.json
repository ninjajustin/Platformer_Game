{"ast":null,"code":"import { __awaiter, __generator } from \"tslib\";\nimport { E_TIMEOUT } from './errors';\n// eslint-disable-next-line @typescript-eslint/explicit-module-boundary-types\nexport function withTimeout(sync, timeout, timeoutError) {\n  var _this = this;\n  if (timeoutError === void 0) {\n    timeoutError = E_TIMEOUT;\n  }\n  return {\n    acquire: function () {\n      return new Promise(function (resolve, reject) {\n        return __awaiter(_this, void 0, void 0, function () {\n          var isTimeout, handle, ticket, release, e_1;\n          return __generator(this, function (_a) {\n            switch (_a.label) {\n              case 0:\n                isTimeout = false;\n                handle = setTimeout(function () {\n                  isTimeout = true;\n                  reject(timeoutError);\n                }, timeout);\n                _a.label = 1;\n              case 1:\n                _a.trys.push([1, 3,, 4]);\n                return [4 /*yield*/, sync.acquire()];\n              case 2:\n                ticket = _a.sent();\n                if (isTimeout) {\n                  release = Array.isArray(ticket) ? ticket[1] : ticket;\n                  release();\n                } else {\n                  clearTimeout(handle);\n                  resolve(ticket);\n                }\n                return [3 /*break*/, 4];\n              case 3:\n                e_1 = _a.sent();\n                if (!isTimeout) {\n                  clearTimeout(handle);\n                  reject(e_1);\n                }\n                return [3 /*break*/, 4];\n              case 4:\n                return [2 /*return*/];\n            }\n          });\n        });\n      });\n    },\n\n    runExclusive: function (callback) {\n      return __awaiter(this, void 0, void 0, function () {\n        var release, ticket;\n        return __generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              release = function () {\n                return undefined;\n              };\n              _a.label = 1;\n            case 1:\n              _a.trys.push([1,, 7, 8]);\n              return [4 /*yield*/, this.acquire()];\n            case 2:\n              ticket = _a.sent();\n              if (!Array.isArray(ticket)) return [3 /*break*/, 4];\n              release = ticket[1];\n              return [4 /*yield*/, callback(ticket[0])];\n            case 3:\n              return [2 /*return*/, _a.sent()];\n            case 4:\n              release = ticket;\n              return [4 /*yield*/, callback()];\n            case 5:\n              return [2 /*return*/, _a.sent()];\n            case 6:\n              return [3 /*break*/, 8];\n            case 7:\n              release();\n              return [7 /*endfinally*/];\n            case 8:\n              return [2 /*return*/];\n          }\n        });\n      });\n    },\n\n    /** @deprecated Deprecated in 0.3.0, will be removed in 0.4.0. Use runExclusive instead. */\n    release: function () {\n      sync.release();\n    },\n    cancel: function () {\n      return sync.cancel();\n    },\n    waitForUnlock: function () {\n      return sync.waitForUnlock();\n    },\n    isLocked: function () {\n      return sync.isLocked();\n    }\n  };\n}","map":null,"metadata":{},"sourceType":"module"}